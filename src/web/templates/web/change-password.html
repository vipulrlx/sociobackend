{% extends 'web/dashboard_layout.html' %}
{% load static %}

{% block page_title %}Change Password{% endblock %}
{% block breadcrumb %}Security{% endblock %}

{% block content %}
<div class="change-password-container">
  <div class="change-password-form-container">
    <div class="form-header">
      <h2 class="form-title">Change Password</h2>
      <p class="form-subtitle">Update your account password</p>
    </div>

    <!-- Error banner -->
    <div id="error" class="error-banner hidden">
      <svg class="error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
        <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span class="error-text"></span>
    </div>

    <!-- Success banner -->
    <div id="success" class="success-banner hidden">
      <svg class="success-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
        <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="success-text">Password changed successfully!</span>
    </div>

    <form id="changePasswordForm" class="change-password-form">
      <div class="form-group">
        <label class="form-label" for="currentPassword">Current Password</label>
        <div class="password-input-container">
          <input 
            class="form-input password-input" 
            type="password" 
            id="currentPassword"
            name="currentPassword" 
            placeholder="Enter your current password" 
            required
            autocomplete="current-password"
          >
          <button type="button" class="password-toggle" id="currentPasswordToggle">
            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="newPassword">New Password</label>
        <div class="password-input-container">
          <input 
            class="form-input password-input" 
            type="password" 
            id="newPassword"
            name="newPassword" 
            placeholder="Enter your new password" 
            minlength="8"
            required
            autocomplete="new-password"
          >
          <button type="button" class="password-toggle" id="newPasswordToggle">
            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirm New Password</label>
        <div class="password-input-container">
          <input 
            class="form-input password-input" 
            type="password" 
            id="confirmPassword"
            name="confirmPassword" 
            placeholder="Confirm your new password" 
            minlength="8"
            required
            autocomplete="new-password"
          >
          <button type="button" class="password-toggle" id="confirmPasswordToggle">
            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
        </div>
      </div>

      <button type="submit" class="change-password-button">
        <span class="button-text">Change Password</span>
      </button>
    </form>
  </div>
</div>

<style>
/* Change password form layout */
.change-password-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 200px);
  padding: 2rem;
}

.change-password-form-container {
  width: 100%;
  max-width: 500px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  padding: 2rem;
  border: 1px solid #e5e7eb;
}

.form-header {
  text-align: center;
  margin-bottom: 2rem;
}

.form-title {
  font-size: 1.875rem;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 0.5rem;
}

.form-subtitle {
  color: #6b7280;
  font-size: 1rem;
}

/* Error banner */
.error-banner {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  color: #dc2626;
  font-size: 0.875rem;
}

.error-banner.hidden {
  display: none;
}

.error-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.error-text {
  flex: 1;
}

/* Success banner */
.success-banner {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  color: #16a34a;
  font-size: 0.875rem;
}

.success-banner.hidden {
  display: none;
}

.success-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.success-text {
  flex: 1;
}

.change-password-form {
  margin-bottom: 2rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: #374151;
  margin-bottom: 0.5rem;
}

.form-input {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.2s ease;
  background: white;
}

.form-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.password-input-container {
  position: relative;
}

.password-input {
  padding-right: 3rem;
}

.password-toggle {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #6b7280;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: color 0.2s ease;
}

.password-toggle:hover {
  color: #374151;
}

.eye-icon {
  width: 18px;
  height: 18px;
}

.change-password-button {
  width: 100%;
  padding: 0.875rem;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.change-password-button:hover {
  background: #5a67d8;
  transform: translateY(-1px);
}

/* Loading state */
.change-password-button.loading {
  pointer-events: none;
  opacity: 0.8;
}

.change-password-button.loading .button-text {
  opacity: 0;
}

.change-password-button.loading::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  border: 2px solid transparent;
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
  .change-password-container {
    padding: 1rem;
  }
  
  .change-password-form-container {
    padding: 1.5rem;
  }
  
  .form-title {
    font-size: 1.5rem;
  }
}

@media (max-width: 480px) {
  .change-password-form-container {
    padding: 1rem;
  }
  
  .form-title {
    font-size: 1.25rem;
  }
}
</style>

<script type="module">
import { API } from "{% static 'web/js/api.js' %}";

// Authentication is now handled by backend middleware

const form = document.getElementById("changePasswordForm");
const error = document.getElementById("error");
const success = document.getElementById("success");
const errorText = error.querySelector(".error-text");

function showError(msg) {
  errorText.textContent = msg;
  error.classList.remove("hidden");
  success.classList.add("hidden");
}

function showSuccess() {
  success.classList.remove("hidden");
  error.classList.add("hidden");
}

function hideMessages() {
  error.classList.add("hidden");
  success.classList.add("hidden");
}

// Password toggle functionality for all password fields
function setupPasswordToggle(inputId, toggleId) {
  const input = document.getElementById(inputId);
  const toggle = document.getElementById(toggleId);
  
  toggle.addEventListener("click", function() {
    const eyeIcon = this.querySelector(".eye-icon");
    
    if (input.type === "password") {
      input.type = "text";
      eyeIcon.innerHTML = `
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20C7 20 2.73 16.89 1 12C2.27 7.11 6.73 4 12 4C13.41 4 14.77 4.3 16.06 4.84L17.94 2.96C16.36 2.18 14.24 1.5 12 1.5C5.5 1.5 1 6.5 1 12C1 17.5 5.5 22.5 12 22.5C14.24 22.5 16.36 21.82 17.94 21.04L17.94 17.94Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14.12 14.12A3 3 0 1 1 9.88 9.88L14.12 14.12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="9" y1="9" x2="23" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      `;
    } else {
      input.type = "password";
      eyeIcon.innerHTML = `
        <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
      `;
    }
  });
}

setupPasswordToggle("currentPassword", "currentPasswordToggle");
setupPasswordToggle("newPassword", "newPasswordToggle");
setupPasswordToggle("confirmPassword", "confirmPasswordToggle");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  hideMessages();

  const fd = new FormData(form);
  const newPassword = fd.get("newPassword");
  const confirmPassword = fd.get("confirmPassword");

  if (newPassword !== confirmPassword) {
    return showError("New passwords do not match.");
  }

  if (newPassword.length < 8) {
    return showError("New password must be at least 8 characters long.");
  }

  const button = e.target.querySelector(".change-password-button");
  const buttonText = button.querySelector(".button-text");
  
  // Add loading state
  button.classList.add("loading");
  buttonText.textContent = "Changing password...";

  try {
    await API.post("auth/change-password/", {
      current_password: fd.get("currentPassword"),
      new_password: newPassword
    });
    
    showSuccess();
    form.reset();
    
    // Redirect to dashboard after 2 seconds
    setTimeout(() => {
      window.location.href = "/";
    }, 2000);
    
  } catch (err) {
    showError(err?.response?.data?.detail ?? "Failed to change password. Please try again.");
  } finally {
    button.classList.remove("loading");
    buttonText.textContent = "Change Password";
  }
});
</script>
{% endblock %} 